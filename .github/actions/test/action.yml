name: test

description: Run tests in specified project

inputs:
  test-options:
    required: true
    type: string

runs:
  using: composite
  steps:
    - name: Run nvidia-smi to make sure GPU is working
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: nvidia-smi

    - name: Download bindings build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.CUDA_BINDINGS_ARTIFACT_NAME }}
        path: ${{ env.CUDA_BINDINGS_ARTIFACTS_DIR }}

    - name: Display structure of downloaded bindings artifacts
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        pwd
        ls -lahR $CUDA_BINDINGS_ARTIFACTS_DIR

    - name: Download core build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.CUDA_CORE_ARTIFACT_NAME }}
        path: ${{ env.CUDA_CORE_ARTIFACTS_DIR }}

    - name: Display structure of downloaded core build artifacts
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        pwd
        ls -lahR $CUDA_CORE_ARTIFACTS_DIR

    - name: Run test / analysis
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        "${{ env.REPO_DIR }}/continuous_integration/scripts/entrypoint" "${{ env.REPO_DIR }}/continuous_integration/scripts/test" ${{ inputs.test-options }}
