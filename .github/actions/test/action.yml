name: test

description: Run tests in specified project

inputs:
  test-options:
    required: true
    type: string
  has-gpu:
    required: true
    type: boolean
    description: "The runner has GPU(s)."

runs:
  using: composite
  steps:
    - if: ${{ inputs.has-gpu == true }}
      name: Run nvidia-smi to make sure GPU is working
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: nvidia-smi

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: ${{ env.ARTIFACTS_DIR }}

    - name: Display structure of downloaded artifacts
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        pwd
        ls -lahR $ARTIFACTS_DIR

    - name: Make test env
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        "${{ env.REPO_DIR }}/continuous_integration/scripts/entrypoint" "${{ env.REPO_DIR }}/continuous_integration/scripts/make-conda-env" test

    - name: Run test / analysis
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        "${{ env.REPO_DIR }}/continuous_integration/scripts/entrypoint" "${{ env.REPO_DIR }}/continuous_integration/scripts/test" ${{ inputs.test-options }}
