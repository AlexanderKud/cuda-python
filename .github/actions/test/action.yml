name: test

description: Run tests in specified project

inputs:
  test-options:
    required: true
    type: string
  runner-has-gpu:
    required: true
    type: boolean
    description: "The runner has GPU(s)."

runs:
  using: composite
  steps:
    - if: ${{ inputs.runner-has-gpu == true }}
      name: Run nvidia-smi to make sure GPU is working
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: nvidia-smi

    - name: Download bindings build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.BINDINGS_ARTIFACT_NAME }}
        path: ${{ env.BINDINGS_ARTIFACTS_DIR }}

    - name: Display structure of downloaded bindings artifacts
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        pwd
        ls -lahR $BINDINGS_ARTIFACTS_DIR

    - name: Download core build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.CORE_ARTIFACT_NAME }}
        path: ${{ env.CORE_ARTIFACTS_DIR }}

    - name: Display structure of downloaded core build artifacts
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        pwd
        ls -lahR $CORE_ARTIFACTS_DIR

    - name: Run test / analysis
      shell: bash --noprofile --norc -xeuo pipefail {0}
      run: |
        "${{ env.REPO_DIR }}/continuous_integration/scripts/entrypoint" "${{ env.REPO_DIR }}/continuous_integration/scripts/test" ${{ inputs.test-options }}
